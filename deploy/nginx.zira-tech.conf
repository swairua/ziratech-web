# Nginx server block example for zira-tech.com
# Place this file in /etc/nginx/sites-available/zira-tech.conf and symlink to sites-enabled

server {
    listen 80;
    listen [::]:80;
    server_name zira-tech.com www.zira-tech.com;

    # Redirect to HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name zira-tech.com www.zira-tech.com;

    # SSL certs (Let's Encrypt path example)
    ssl_certificate /etc/letsencrypt/live/zira-tech.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/zira-tech.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    root /var/www/zira-tech.com; # adjust to your site root containing index.html and api.php
    index index.html index.php;

    client_max_body_size 20M;

    # Serve static files directly
    location /assets/ {
        try_files $uri $uri/ =404;
        access_log off;
        expires 30d;
    }

    # Serve uploads via PHP endpoint (prefer using signed URLs)
    location /uploads/ {
        # If you choose to expose uploads directly, point to storage/uploads symlinked into webroot
        # try_files $uri $uri/ =404;
        return 404; # recommended: disallow direct access, use serve_upload.php
    }

    # PHP scripts
    location ~ ^/(api\.php|serve_upload\.php)$ {
        fastcgi_pass unix:/run/php/php8.1-fpm.sock; # adjust PHP-FPM socket or use host:port
        fastcgi_index api.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTPS on;
    }

    # Deny access to storage directory by default
    location ^~ /storage/ {
        deny all;
        return 404;
    }

    # SPA fallback
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' 'unsafe-inline' https:;" always;
}
